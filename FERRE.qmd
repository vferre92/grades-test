---
title: "FERRE"
format: html
---

Link to the github repository : https://github.com/vferre92/grades-test.git


```{r}

#| false
here::i_am("grades-test.Rproj")
library(here)
library(dplyr)
library(tidyr)
library(ggplot2)
library(vroom)
library(gt)
library(readr)
library(lubridate)

```

### 1.1 Study organisation

#### Question 1 :  Load the course description file.

```{r}
courses <- vroom(here("data", "courses.csv"))
View(courses)

```
### Question 2 :

```{r}
courses |>
  arrange(course) |>
  gt::gt() |>
  tab_header(title = "Courses Data")

```


###  1.2 Students

####  Question 3

```{r}
students <- vroom(here("data", "students.csv"))
View(students)

```
```{r}
print(class(students$birth_date)) 
```
The variable "birth_date" is of class " `{r} print(class(students$birth_date))` "

```{r}
print(class(students$sex)) 
```

The variable "sex" is of class " `{r} print(class(students$sex))` "
Transformons la variable "sex" en *factor* :

```{r}
students <- students |>
  mutate(sex = factor(sex)) 
print(class(students$sex))
```
The variable "sex" is now of class " `{r} print(class(students$sex))` "

####  Question 4

```{r}

grades <- vroom(here("data", "grades.csv"))
View(grades)

```
Problème d'encodage, changeons cela :

```{r}

grades <- vroom(here("data", "grades.csv"), delim = ":", na = "unknown")
View(grades)

```
#### Question 5

```{r}

students |>
  ggplot(aes(x = factor(group))) +
  geom_bar(fill = "steelblue") +
  labs(title = "Number of Students per Group", x = "Group", y = "Nb of Students") +
  geom_text(stat = 'count', aes(label = after_stat(count)), vjust = -0.5) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(breaks = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18"))

```

#### Question 6

```{r}

students |>
  ggplot(aes(x = group, fill = sex)) +
  geom_bar(position = "fill") +
  labs(title = "Gender Balance in Each Group", x = "Group Number", y = "Proportion of Students") +
  scale_fill_manual(values = c("lightgreen", "lightsalmon")) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) 

```
#### Question 7 

```{r}
students <- students |>
  mutate(age = round(time_length(today() - birth_date, unit = "year")))

students |>
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "lightblue", color = "darkblue") +
  labs(title = "Distribution of Students' age (Count)", x = "age", y = "Count of Students") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```
#### Question 8 

```{r}
students <- students |>
  mutate(age = round(time_length(today() - birth_date, unit = "year")))

median_age_by_group <- students |>
  group_by(group) |>
  summarise(Median_age = median(age, na.rm = TRUE)) |>
  ungroup() |>
  mutate(Median_age = round(Median_age))

median_age_by_group |>
  gt::gt() |>
  tab_header(title = "Median Age of Students by Group") |>
  cols_label(group = "Group ID", Median_age = "Median Age") |>
  fmt_number(columns = Median_age, decimals = 0)
```

#### Question 9

```{r}

oldest_students <- students |>
  group_by(group) |>
  slice_max(age, n = 1) |>
  ungroup() |>
  select(id, sex, age, group) |>
  arrange(desc(age))

oldest_students |>
  gt() |>
  tab_header(title = "Oldest Student in Each Group") |>
  cols_label(id = "Student ID",sex = "Gender",age = "Age", group = "nb_Group") |>
  fmt_number(columns = age, decimals = 0)


```

### 3 Simple grade analysis

#### Question 10

```{r}
nb_grades <- grades |>
  filter(!is.na(grade)) |>
  nrow()
```

Le nombre de notes, sans compter les missings values, est de `r nb_grades`.

#### Question 11

```{r}

grades_courses <- grades |>
  inner_join(courses, by = "course_id")

```

```{r}

grades_courses |>
  inner_join(students |> select(id, group), by = "id") |>
  filter(course == "Post-Apocalyptic History and Archaeology") |>
  group_by(group) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE)) |>
  ungroup() |>
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "steelblue") +
  labs(title = "Average Grade in Post-Apocalyptic History and Archaeology by Group",x = "Group ID",y = "Average Grade") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

```

#### Question 12

```{r}

grades_courses |>
  filter(!is.na(grade)) |>
  ggplot(aes(x = grade)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  facet_wrap(vars(trimester)) +
  labs(title = "Distribution of Grades by Trimester",x = "Grade",y = "Density") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

```
###  4 Attendance analysis

#### Question 13

```{r}
grades_courses_students <- grades_courses |>
  inner_join(students |> select(id, group, sex), by = "id")

grades_per_student <- grades_courses_students |>
  group_by(id, group, sex) |>
  filter(!is.na(grade)) |>
  summarise(nb_grades = n(),Min_Grade = min(grade, na.rm = TRUE),Max_Grade = max(grade, na.rm = TRUE),.groups = "drop") |>
  ungroup()

grades_per_student |>
  summarise(Minimum = min(nb_grades),Maximum = max(nb_grades),Average = mean(nb_grades),Median = median(nb_grades)) |>
  gt::gt()
```

```{r}
grades_per_student |>
  slice_head(n = 10) |>
  gt() |>
  tab_header(
    title = "Extract of Grades per Student") |>
  cols_label(id = "Student ID",group = "Group ID",sex = "Gender",nb_grades = "Number of Grades",Min_Grade = "Min Grade",Max_Grade = "Max Grade")

```

#### Question 14

```{r}
grades_per_student |>
  ggplot(aes(x = sex, y = nb_grades, fill = sex)) +
  geom_violin() +
  geom_boxplot(width = 0.1, color = "black", fill = "white", alpha = 0.5) +
  labs(title = "Distribution of Number of Grades by Gender",x = "gender",y = "nb of grades",fill = "gender"
  ) +
  scale_fill_manual(values = c("F" = "lightgreen", "M" = "lightsalmon")) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```
#### Question 15

```{r}

grades_specific_course <- grades_courses_students |>
  filter(course == "Community Building and Social Organization") |>
  filter(!is.na(grade)) |>
  group_by(id, group, sex) |>
  summarise(nb_grades_course = n(),.groups = "drop") |>
  ungroup()

grades_specific_course |>
  slice_head(n = 10) |>
  gt::gt() |>
  tab_header(title = "Number of Grades in Community Building and Social Organization") |>
  cols_label(id = "Student ID",group = "nb_Group",sex = "Gender",nb_grades_course = "Nb Grades")

```


### Question 16

```{r}
grades_specific_course |>
  group_by(nb_grades_course) |>
  summarise(nb_students = n(),.groups = "drop") |>
  ggplot(aes(x = nb_grades_course, y = nb_students)) +
  geom_line(linewidth = 1, color = "darkblue") +
  geom_point(size = 3, color = "darkblue") +
  labs(title = "Distribution of Number of Grades per Student in Specific Course",x = "Number of Grades (nb_grades_course)",y = "Number of Students (Count)") +
  geom_text(aes(label = nb_students), vjust = -1) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```
Le dernier chiffre est malheureusement un peu tronqué, je ne prendrais pas le temps de régler ceci (c'est 638).


#### Question 17

```{r}

grades_specific_course <- grades_specific_course |>
  mutate(grade_count_category = cut(nb_grades_course, breaks = c(6.5, 7.5, 8.5, 9.5, 10.5),labels = c("7 Grades", "8 Grades", "9 Grades", "10 Grades"),include.lowest = TRUE,right = TRUE))

```

```{r}
grades_specific_course |>
  ggplot(aes(x = factor(group), fill = grade_count_category)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion de Catégories de Nombre de Notes par Groupe",x = "Group ID",y = "Proportion d'Étudiants",fill = "Nb de Notes Catégories") +
  scale_fill_manual(values = c("7 Grades" = "#E7B800", "8 Grades" = "#2E9FDF", "9 Grades" = "#00AFBB", "10 Grades" = "#FC4E07")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),plot.title = element_text(hjust = 0.5))
```
#### Question 18

```{r}
grades_specific_course |>
  ggplot(aes(x = nb_grades_course, fill = sex)) +
  geom_density(alpha = 0.5, position = "identity") +
  facet_wrap(vars(group)) +
  labs(title = "Densité du Nombre de Notes par Groupe et Genre",x = "Nombre de Notes (nb_grades_course) - Discret",y = "Densité",fill = "Genre") +
  scale_x_continuous(breaks = 7:10) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```
### 5 Grade analysis

#### Question 19

```{r}
grades_avg_per_course <- grades_courses_students |>
  filter(!is.na(grade)) |>
  group_by(id, group, course) |>
  summarise(Avg_Grade = mean(grade, na.rm = TRUE),.groups = "drop") |>
  ungroup()

grades_wide_avg <- grades_avg_per_course |>
  pivot_wider(names_from = course,values_from = Avg_Grade)

```

```{r}
grades_avg_per_course <- grades_courses_students |>
  filter(!is.na(grade)) |>
  group_by(id, group, course) |>
  summarise(
    Avg_Grade = mean(grade, na.rm = TRUE),
    .groups = "drop"
  ) |>
  ungroup()

grades_wide_avg <- grades_avg_per_course |>
  pivot_wider(
    names_from = course,
    values_from = Avg_Grade
  )
```

```{r}
grades_wide_avg |>
  select(id, group, everything()) |>
  slice_head(n = 5) |>
  gt() |>
  fmt_number(columns = -c(id, group),decimals = 2) |>
  tab_options(column_labels.font.size = "small")
```

#### Question 20

```{r}

grades_wide_avg |>
  ggplot(aes(x = `Art and Expression in a Post-Apocalyptic World`,y = `Survival Skills and Wilderness Medicine`)) +
  geom_point(color = "darkred", size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", formula = y ~ x, color = "blue", se = FALSE) +
  labs(title = "Relation entre la Note Moyenne en Art et en Survie",x = "Moyenne en Art and Expression in a Post-Apocalyptic World",y = "Moyenne en Survival Skills and Wilderness Medicine") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

```
Mais ce n'est pas particulièrement visible. Utilisons en alternative geom_hex pour mettre mieux en relief les concentrations d'étudiant par rapport aux différentes moyennes dont nous souhaitons observer une corrélation.

```{r}

grades_wide_avg |>
  ggplot(aes(x = `Art and Expression in a Post-Apocalyptic World`,y = `Survival Skills and Wilderness Medicine`)) +
  geom_hex(bins = 15) +
  geom_smooth(method = "lm", formula = y ~ x, color = "red", linewidth = 1,se = FALSE) +
  scale_fill_continuous(type = "viridis") + # Améliore la palette de couleurs
  labs(title = "Densité des Notes (Hexagones) : Art vs. Survie",x = "Moyenne en Art and Expression in a Post-Apocalyptic World",y = "Moyenne en Survival Skills and Wilderness Medicine",fill = "Nombre d'Étudiants") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

```
Nous pouvons observer une certaine logique dans ce résultat : une majorité d'étudiant ont des moyennes cohérente entre les différentes doublettes de cours. Exemple : environ 25 étudiants ont en moyenne environ 13 dans la doublette en axe y, et environ 13-14 dans l'autre.


#### Question 21

```{r}

correlation_by_group <- grades_wide_avg |>
  group_by(group) |>
  summarise(Correlation_Coefficient = cor(`Mechanical Engineering and Vehicle Repair`,`Survival Skills and Wilderness Medicine`,use = "pairwise.complete.obs"),.groups = "drop") |>
  arrange(desc(abs(Correlation_Coefficient)))

correlation_by_group |>
  gt() |>
  cols_label(group = "Group ID",Correlation_Coefficient = "Coefficient de Corrélation") |>
  fmt_number(columns = Correlation_Coefficient,decimals = 3)


```

#### Question 22

```{r}
most_correlated_group_info <- correlation_by_group |>
  slice_max(abs(Correlation_Coefficient), n = 1, with_ties = FALSE)

target_group <- most_correlated_group_info$group
target_correlation <- most_correlated_group_info$Correlation_Coefficient

print(paste("Groupe cible (corrélation la plus forte) :", target_group))
print(paste("Coefficient de corrélation (r) :", round(target_correlation, 3)))
```

```{r}
grades_wide_avg |>
  filter(group == target_group) |>
  ggplot(aes(x = `Survival Skills and Wilderness Medicine`,y = `Mechanical Engineering and Vehicle Repair`)) +
  geom_point(color = "steelblue", size = 3, alpha = 0.8) +
  geom_smooth(method = "lm",formula = y ~ x,color = "red",linewidth = 1,se = FALSE) +
  labs(title = paste("Corrélation des Notes (Groupe", target_group, ")"),subtitle = paste("r =", round(target_correlation, 3)),x = "Moyenne en Survival Skills and Wilderness Medicine",y = "Moyenne en Mechanical Engineering and Vehicle Repair") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```
We have a clear negative correlation between the two average of the two courses.


#### Question 23

```{r}

grades_only <- grades_wide_avg |>
  select(-id, -group)

final_grades_calc <- grades_wide_avg |>
  mutate(
    final_grade = rowMeans(grades_only, na.rm = TRUE)
  ) |>
  select(id, group, final_grade)

final_grades_df <- final_grades_calc |>
  inner_join(students |> select(id, sex), by = "id") |>
  arrange(desc(final_grade))

```

```{r}
final_grades_df |>
  slice_head(n = 5) |>
  gt() |>
  cols_label(
    id = "ID",
    group = "Group",
    sex = "Sex",
    final_grade = "Final Grade"
  ) |>
  fmt_number(
    columns = final_grade,
    decimals = 3
  ) |>
  tab_header(
    title = "Top 5 Students by Final Grade"
  )
```

#### Question 24 

```{r}

final_grades_df |>
  ggplot(aes(x = factor(group), y = final_grade, fill = factor(group))) +
  geom_boxplot() +
  labs(
    title = "Comparaison de la Note Finale par Groupe",
    x = "Group ID",
    y = "Note Finale Moyenne",
    fill = "Group ID"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

```

#### Question 25 

```{r}
final_grades_df |>
  ggplot(aes(x = factor(group), y = final_grade, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Note Finale par Groupe et par Genre",
    x = "Group ID",
    y = "Note Finale Moyenne",
    fill = "Genre"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```
Cela fonctionne, mais ce n'est pas nécéssairement le plus lisible. Utilison facet_wrap et geom.density pour avoir une meilleure visualisation (à mon sens)

```{r}
final_grades_df |>
  ggplot(aes(x = final_grade, fill = sex)) +
  geom_density(alpha = 0.5, position = "identity") +
  facet_wrap(~group) +
  labs(
    title = "Densité de la Note Finale par Groupe et par Genre",
    x = "Note Finale Moyenne",
    y = "Densité",
    fill = "Genre"
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```
#### Question 26

```{r}

course_trimester_map <- grades_courses_students |>
  select(course, trimester) |>
  distinct()

c1_pass <- grades_avg_per_course |>
  group_by(id) |>
  summarise(
    Min_Course_Grade = min(Avg_Grade, na.rm = TRUE),
    C1_Passed = Min_Course_Grade >= 5,
    .groups = "drop"
  ) |>
  select(id, C1_Passed)

grades_avg_with_trimester <- grades_avg_per_course |>
  inner_join(course_trimester_map, by = "course")

avg_grade_trimester <- grades_avg_with_trimester |>
  group_by(id, trimester) |>
  summarise(
    Avg_Trimester = mean(Avg_Grade, na.rm = TRUE),
    .groups = "drop"
  )

c2_pass <- avg_grade_trimester |>
  group_by(id) |>
  summarise(
    Min_Trimester_Grade = min(Avg_Trimester, na.rm = TRUE),
    C2_Passed = Min_Trimester_Grade >= 10,
    .groups = "drop"
  ) |>
  select(id, C2_Passed)

pass_conditions_df <- c1_pass |>
  inner_join(c2_pass, by = "id")

pass_final_df_q26 <- final_grades_df |>
  inner_join(pass_conditions_df, by = "id") |>
  mutate(
    pass = C1_Passed & C2_Passed
  ) |>
  select(id, group, sex, final_grade, pass) |>
  arrange(desc(final_grade))

```

```{r}

pass_final_df_q26 |>
  slice_head(n = 10) |>
  gt() |>
  cols_label(
    id = "ID",
    group = "Group",
    sex = "Sex",
    final_grade = "Final Grade",
    pass = "Pass Year"
  ) |>
  fmt_number(
    columns = final_grade,
    decimals = 3
  )

```

